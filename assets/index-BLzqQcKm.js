(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function s(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(n){if(n.ep)return;n.ep=!0;const o=s(n);fetch(n.href,o)}})();class O{constructor(){this.config=null,this.currentStateId=null,this.context={},this.history=[],this.listeners=[]}load(e){if(console.log("VisualizerEngine: Loading config",e==null?void 0:e.id),!e||!e.states){console.error("VisualizerEngine: Invalid config provided");return}this.config=e,this.context=JSON.parse(JSON.stringify(e.context||{})),this.currentStateId=e.initialState,this.history=[],this.recordHistory("Initial State"),this.notify(),console.log("VisualizerEngine: Load complete. Current state:",this.currentStateId)}subscribe(e){this.listeners.push(e)}notify(){this.listeners.forEach(e=>e(this.getState()))}send(e,s={}){const n=this.config.states[this.currentStateId].on[e];if(!n)return console.error(`No transition found for event ${e} in state ${this.currentStateId}`),!1;if(n.action)try{const o=new Function("context","input",`
                    ${n.action};
                    return context;
                `);this.context=o(JSON.parse(JSON.stringify(this.context)),s)}catch(o){return console.error(`Action error for ${e}:`,o),{error:o.message}}return this.currentStateId=n.to,this.recordHistory(e,s),this.notify(),!0}recordHistory(e,s={}){this.history.push({timestamp:new Date().toLocaleTimeString(),state:this.currentStateId,event:e,context:JSON.parse(JSON.stringify(this.context)),input:JSON.parse(JSON.stringify(s))})}generateMermaid(){if(!this.config)return"";let e=`stateDiagram-v2
`;return e+=`    direction LR

`,e+=`    classDef current fill:#6366f1,stroke:#fff,stroke-width:2px,color:#fff

`,Object.entries(this.config.states).forEach(([s,r])=>{const n=r.label||s;e+=`    state "${n}" as ${s}
`,s===this.currentStateId&&(e+=`    class ${s} current
`)}),e+=`
`,Object.entries(this.config.states).forEach(([s,r])=>{r.on&&Object.entries(r.on).forEach(([n,o])=>{const i=o.label||n;e+=`    ${s} --> ${o.to}: ${i}
`})}),e}getState(){const e=this.config?this.config.states[this.currentStateId]:null;return!e&&this.config&&console.warn(`VisualizerEngine: State ${this.currentStateId} not found in config`),{id:this.currentStateId,data:e,context:this.context,availableEvents:e?e.on:{},mermaid:this.generateMermaid(),history:this.history}}undo(){if(this.history.length<=1)return;this.history.pop();const e=this.history[this.history.length-1];this.currentStateId=e.state,this.context=JSON.parse(JSON.stringify(e.context)),console.log("VisualizerEngine: Undo to",this.currentStateId),this.notify()}async replay(e,s=500){console.log("VisualizerEngine: Starting replay of",e.length,"events"),this.reset();for(const r of e)await new Promise(n=>setTimeout(n,s)),this.send(r.event,r.input);console.log("VisualizerEngine: Replay complete")}reset(){this.config&&(console.log("VisualizerEngine: Resetting"),this.load(this.config))}}const l=new O;window.engine=l;let y;const N="default-example.json";mermaid.initialize({startOnLoad:!1,theme:"dark",securityLevel:"loose",state:{useMaxWidth:!1}});require.config({paths:{vs:"https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs"}});require(["vs/editor/editor.main"],function(){y=monaco.editor.create(document.getElementById("editor-container"),{value:"",language:"json",theme:"vs-dark",automaticLayout:!0,minimap:{enabled:!1},fontSize:13,lineNumbers:"on",scrollBeyondLastLine:!1,roundedSelection:!1,padding:{top:10}}),I()});const p=document.getElementById("resizer");document.getElementById("editor-panel");let f=!1;p.addEventListener("mousedown",t=>{f=!0,p.classList.add("active"),document.body.style.cursor="col-resize",document.body.style.userSelect="none"});document.addEventListener("mousemove",t=>{if(!f)return;const e=Math.max(200,Math.min(window.innerWidth-450,t.clientX));document.documentElement.style.setProperty("--editor-width",`${e}px`),y&&y.layout()});document.addEventListener("mouseup",()=>{f&&(f=!1,p.classList.remove("active"),document.body.style.cursor="default",document.body.style.userSelect="auto")});async function I(){try{const t=await fetch(N);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const e=await t.json();y.setValue(JSON.stringify(e,null,2)),w()}catch(t){$("Failed to load default config: "+t.message)}}function w(){try{const t=y.getValue(),e=JSON.parse(t);document.getElementById("error-overlay").style.display="none",l.listeners.length===0&&l.subscribe(T),l.load(e)}catch(t){$("Invalid JSON: "+t.message)}}function $(t){document.getElementById("error-overlay").style.display="flex",document.getElementById("error-message").textContent=t}document.getElementById("btn-apply-json").onclick=w;document.getElementById("btn-reset-json").onclick=I;document.getElementById("btn-hide-error").onclick=()=>{document.getElementById("error-overlay").style.display="none"};function x(){var t;return`visualizer_view_${(t=l.config)==null?void 0:t.id}`}let b=!0;const z=document.getElementById("mermaid-root");["mousedown","touchstart","wheel"].forEach(t=>{z.addEventListener(t,()=>{b=!1},{passive:!0})});function S(){if(!d||!l.config||b)return;const t={pan:d.getPan(),zoom:d.getZoom(),scenarioId:l.config.id};localStorage.setItem(x(),JSON.stringify(t))}function J(){var s;const t=(s=l.config)==null?void 0:s.id;if(!t)return null;const e=localStorage.getItem(x());if(!e)return null;try{const r=JSON.parse(e);return r.scenarioId===t?r:null}catch{return null}}window.switchTab=function(t){document.getElementById("panel-context").classList.toggle("hidden",t!=="context"),document.getElementById("panel-history").classList.toggle("hidden",t!=="history"),document.getElementById("tab-btn-context").classList.toggle("active",t==="context"),document.getElementById("tab-btn-history").classList.toggle("active",t==="history")};let d;async function T(t){var r,n,o;(r=l.config)==null||r.id;const e=J();d&&(d.destroy(),d=null),document.getElementById("current-state-label").textContent=((n=t.data)==null?void 0:n.label)||t.id,document.getElementById("current-state-desc").textContent=((o=t.data)==null?void 0:o.description)||"",document.getElementById("state-json").textContent=JSON.stringify(t.context,null,2);const s=document.getElementById("history-log");s&&(s.innerHTML=t.history.slice().reverse().map(i=>`
                    <div class="history-item">
                        <span class="time">${i.timestamp}</span>
                        <span class="event">${i.event}</span>
                        <div style="font-size: 0.7rem; opacity: 0.6;">To: ${i.state}</div>
                    </div>
                `).join(""));try{const i=document.getElementById("mermaid-root");i.removeAttribute("data-processed"),i.innerHTML=t.mermaid,await mermaid.run({nodes:[i]});const a=i.querySelector("svg");a&&(b=!0,d=svgPanZoom(a,{zoomEnabled:!0,controlIconsEnabled:!1,fit:!e,center:!e,minZoom:.05,maxZoom:20,onZoom:()=>S(),onPan:()=>S()}),window.panZoom=d,e&&(d.zoom(e.zoom),d.pan(e.pan)))}catch(i){console.error("Mermaid/PanZoom Error:",i)}j(t)}function j(t){const e=document.getElementById("controls-root");e.innerHTML="";const s=Object.entries(t.availableEvents||{});if(s.length===0){e.innerHTML='<p style="color: var(--text-muted); font-size: 0.8rem; font-style: italic;">No actions available in this state.</p>';return}s.forEach(([r,n])=>{const o=document.createElement("div");o.className="input-group";const i=document.createElement("button");i.className="btn-action",i.innerHTML=`
                    <span class="label">${n.label||r}</span>
                    <span class="target">→ ${t.id!==n.to?n.to:"Self"}</span>
                `,n.inputs&&n.inputs.forEach(a=>{const u=document.createElement("div");u.className="input-field",a.type==="table"?u.innerHTML=`
                                <label>${a.label||a.name}</label>
                                <div class="table-input-container">
                                    <table class="input-table" id="table-${r}-${a.name}">
                                        <thead>
                                            <tr>
                                                ${a.columns.map(c=>`<th>${c.label||c.name}</th>`).join("")}
                                                <th style="width: 30px;"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Rows injected here -->
                                        </tbody>
                                    </table>
                                    <button class="btn-table-add" onclick="addTableRow('${r}', '${a.name}', ${JSON.stringify(a.columns).replace(/"/g,"&quot;")})">
                                        + Add Row
                                    </button>
                                </div>
                            `:u.innerHTML=`
                                <label>${a.label||a.name}</label>
                                <input type="${a.type||"text"}" 
                                       id="input-${r}-${a.name}" 
                                       value="${a.default||""}">
                            `,o.appendChild(u)}),i.onclick=()=>{const a={};n.inputs&&n.inputs.forEach(c=>{if(c.type==="table"){const L=document.getElementById(`table-${r}-${c.name}`).querySelectorAll(".table-row");a[c.name]=Array.from(L).map(B=>{const E={};return c.columns.forEach(h=>{const v=B.querySelector(`[data-col="${h.name}"]`);E[h.name]=h.type==="number"?parseFloat(v.value):v.value}),E})}else{const g=document.getElementById(`input-${r}-${c.name}`).value;a[c.name]=c.type==="number"?parseFloat(g):g}});const u=l.send(r,a);u&&u.error&&alert("Action Error: "+u.error)},o.appendChild(i),e.appendChild(o)})}window.addTableRow=function(t,e,s){const r=document.querySelector(`#table-${t}-${e} tbody`),n=document.createElement("tr");n.className="table-row";let o=s.map(i=>`
                <td>
                    <input type="${i.type==="number"?"number":"text"}" 
                           data-col="${i.name}" 
                           value="${i.default||""}">
                </td>
            `).join("");o+=`<td><button class="btn-table-del" onclick="this.closest('tr').remove()">✕</button></td>`,n.innerHTML=o,r.appendChild(n)};let m=[];window.exitReplay=function(){m=[],document.getElementById("replay-controls").style.display="none",document.getElementById("controls-root").style.display="block"};document.getElementById("btn-replay").onclick=()=>{const t=l.history;t.length<=1||(m=t.slice(1).map(e=>({event:e.event,input:e.input})),l.reset(),document.getElementById("replay-controls").style.display="block",document.getElementById("controls-root").style.display="none",document.getElementById("replay-remaining").textContent=`${m.length} steps remaining`)};document.getElementById("btn-replay-next").onclick=()=>{if(m.length===0)return;const t=m.shift();l.send(t.event,t.input),m.length===0?setTimeout(()=>{alert("Replay Finished!"),exitReplay()},100):document.getElementById("replay-remaining").textContent=`${m.length} steps remaining`};
